{% extends "base.html" %}

{% block head %}
<style>
  [card-options] {
    display: none;
    cursor: pointer;
    min-width: 8.85rem;
    min-height: 7.6rem;
    /* background-color: #ffffff; */
    box-shadow: 0px 1px 3px 2px rgba(0, 0, 0, 0.10);

    &+[card-options] {
      margin-left: 1.2rem;
    }

    &+div[todos_acessos] {
      margin-left: 1.2rem;
    }
  }

  [todos_acessos],
  [visitant],
  [cliente],
  [funcionario],
  [gerente] {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<section class="flex flex-col min-h-full min-w-full">

  <header class="fixed z-50 w-full py-2 bg-[#FFE7D3]">
    <div class="flex max-w-6xl my-0 mx-auto px-8 items-center justify-between">

      <div class="flex items-center">
        <div class="flex items-center cursor-pointer" onclick="back()">
          <svg width="11" height="20" viewBox="0 0 11 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 1L1 10L10 19" stroke="#444444" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          <span class="text-[#444444] ml-3">Voltar</span>
        </div>
        <div class="ml-2">
          <p class="ml-2 text-[#417453] whitespace-pre text-sm font-bold -mb-1">Môdulo</p>
          <p class="ml-2 text-[#444444] whitespace-pre">Avaliação de Itens + Gestão de Créditos</p>
        </div>
      </div>

      <div class="flex items-center">

        <div class="flex items-center">
          <div>
            <p nome_usuario class="mr-2 text-[#444444]">Desconhecido</p>
            <div class="mr-2 flex items-center">
              <svg width="24" height="24" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="9" cy="9" r="9" fill="#417453" />
                <path
                  d="M5.16875 12.8313C5.06563 12.7281 5.01406 12.5969 5.01406 12.4375C5.01406 12.2781 5.06563 12.1469 5.16875 12.0437L5.94219 11.2703C5.64219 10.8859 5.41006 10.4594 5.24581 9.99062C5.08156 9.52187 4.99963 9.025 5 8.5C5 7.24375 5.43594 6.17969 6.30781 5.30781C7.17969 4.43594 8.24375 4 9.5 4H14V8.5C14 9.75625 13.5641 10.8203 12.6922 11.6922C11.8203 12.5641 10.7563 13 9.5 13C8.975 13 8.48038 12.9179 8.01613 12.7536C7.55188 12.5894 7.12775 12.3574 6.74375 12.0578L5.95625 12.8313C5.85313 12.9344 5.72188 12.9859 5.5625 12.9859C5.40313 12.9859 5.27188 12.9344 5.16875 12.8313ZM7.44688 10.5531C7.55 10.675 7.68125 10.7337 7.84063 10.7292C8 10.7247 8.13594 10.666 8.24844 10.5531L10.4563 8.34531C10.5688 8.23281 10.625 8.09931 10.625 7.94481C10.625 7.79031 10.5688 7.65663 10.4563 7.54375C10.3531 7.44063 10.2219 7.38906 10.0625 7.38906C9.90313 7.38906 9.77188 7.44063 9.66875 7.54375L7.44688 9.76562C7.34375 9.86875 7.29219 9.99775 7.29219 10.1526C7.29219 10.3075 7.34375 10.441 7.44688 10.5531Z"
                  fill="white" />
              </svg>
              <p creditos_usuario class="ml-2 text-[#417453]">?? Ecoins</p>
            </div>
          </div>

          <div class="flex items-center justify-center w-12 h-12 rounded-full bg-[#FFCA9D]">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M12 0.5C18.3514 0.5 23.5 5.64855 23.5 12C23.504 14.6541 22.5862 17.2272 20.9033 19.2795L20.9263 19.3048L20.7745 19.4336C19.6961 20.7092 18.3521 21.734 16.8366 22.4363C15.321 23.1387 13.6704 23.5017 12 23.5C8.6075 23.5 5.56001 22.0314 3.45551 19.6969L3.22551 19.4324L3.07371 19.3059L3.09671 19.2783C1.41398 17.2264 0.496127 14.6537 0.500012 12C0.500012 5.64855 5.64856 0.5 12 0.5ZM12 17.75C9.861 17.75 7.92785 18.4308 6.48805 19.3657C8.07769 20.559 10.0123 21.2028 12 21.2C13.9877 21.2028 15.9223 20.559 17.5119 19.3657C15.8666 18.3119 13.9539 17.7512 12 17.75ZM12 2.8C10.2687 2.79995 8.57253 3.28842 7.10643 4.20927C5.64034 5.13011 4.46383 6.44596 3.71214 8.00555C2.96045 9.56515 2.66408 11.3052 2.85711 13.0257C3.05013 14.7462 3.72471 16.3773 4.80331 17.7316C6.66746 16.3941 9.21125 15.45 12 15.45C14.7887 15.45 17.3325 16.3941 19.1967 17.7316C20.2753 16.3773 20.9499 14.7462 21.1429 13.0257C21.3359 11.3052 21.0395 9.56515 20.2879 8.00555C19.5362 6.44596 18.3597 5.13011 16.8936 4.20927C15.4275 3.28842 13.7313 2.79995 12 2.8ZM12 5.1C13.22 5.1 14.39 5.58464 15.2527 6.44731C16.1154 7.30997 16.6 8.48 16.6 9.7C16.6 10.92 16.1154 12.09 15.2527 12.9527C14.39 13.8154 13.22 14.3 12 14.3C10.78 14.3 9.60998 13.8154 8.74731 12.9527C7.88464 12.09 7.4 10.92 7.4 9.7C7.4 8.48 7.88464 7.30997 8.74731 6.44731C9.60998 5.58464 10.78 5.1 12 5.1ZM12 7.4C11.39 7.4 10.805 7.64232 10.3737 8.07365C9.94232 8.50499 9.7 9.09 9.7 9.7C9.7 10.31 9.94232 10.895 10.3737 11.3263C10.805 11.7577 11.39 12 12 12C12.61 12 13.195 11.7577 13.6263 11.3263C14.0577 10.895 14.3 10.31 14.3 9.7C14.3 9.09 14.0577 8.50499 13.6263 8.07365C13.195 7.64232 12.61 7.4 12 7.4Z"
                fill="#417453" />
            </svg>
          </div>
        </div>

        <div onclick="backModule()"
          class="flex ml-2 cursor-pointer items-center justify-center py-2 px-4 rounded-md bg-[#FFD1D1] hover:bg-[#FFADAD]">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M14.945 1.25C13.578 1.25 12.475 1.25 11.608 1.367C10.708 1.487 9.94996 1.747 9.34796 2.348C8.82396 2.873 8.55796 3.518 8.41896 4.276C8.28396 5.013 8.25796 5.914 8.25196 6.996C8.2509 7.19491 8.3289 7.3861 8.46881 7.5275C8.60871 7.6689 8.79905 7.74894 8.99796 7.75C9.19688 7.75106 9.38806 7.67306 9.52947 7.53316C9.67087 7.39326 9.7509 7.20291 9.75196 7.004C9.75796 5.911 9.78596 5.136 9.89396 4.547C9.99896 3.981 10.166 3.652 10.409 3.409C10.686 3.132 11.075 2.952 11.809 2.853C12.564 2.752 13.565 2.75 15 2.75H16C17.436 2.75 18.437 2.752 19.192 2.853C19.926 2.952 20.314 3.133 20.592 3.409C20.868 3.686 21.048 4.074 21.147 4.809C21.249 5.563 21.25 6.565 21.25 8V16C21.25 17.435 21.249 18.436 21.147 19.192C21.048 19.926 20.868 20.314 20.591 20.591C20.314 20.868 19.926 21.048 19.192 21.147C18.437 21.248 17.436 21.25 16 21.25H15C13.565 21.25 12.564 21.248 11.808 21.147C11.075 21.048 10.686 20.867 10.409 20.591C10.166 20.347 9.99896 20.019 9.89396 19.453C9.78596 18.864 9.75796 18.089 9.75196 16.996C9.75144 16.8975 9.73152 16.8001 9.69334 16.7093C9.65517 16.6185 9.59948 16.5361 9.52947 16.4668C9.45945 16.3976 9.37648 16.3428 9.28528 16.3056C9.19409 16.2684 9.09646 16.2495 8.99796 16.25C8.89947 16.2505 8.80205 16.2704 8.71126 16.3086C8.62046 16.3468 8.53808 16.4025 8.46881 16.4725C8.39953 16.5425 8.34473 16.6255 8.30752 16.7167C8.27032 16.8079 8.25144 16.9055 8.25196 17.004C8.25796 18.086 8.28396 18.987 8.41896 19.724C8.55896 20.482 8.82396 21.127 9.34896 21.652C9.94996 22.254 10.709 22.512 11.609 22.634C12.475 22.75 13.578 22.75 14.945 22.75H16.055C17.423 22.75 18.525 22.75 19.392 22.634C20.292 22.512 21.05 22.254 21.652 21.652C22.254 21.05 22.512 20.292 22.634 19.392C22.75 18.525 22.75 17.422 22.75 16.055V7.945C22.75 6.578 22.75 5.475 22.634 4.608C22.513 3.708 22.254 2.95 21.652 2.348C21.05 1.746 20.292 1.488 19.392 1.367C18.525 1.25 17.422 1.25 16.055 1.25H14.945Z"
              fill="#FF3838" />
            <path
              d="M15.0001 11.25C15.199 11.25 15.3897 11.329 15.5304 11.4697C15.6711 11.6103 15.7501 11.8011 15.7501 12C15.7501 12.1989 15.6711 12.3897 15.5304 12.5303C15.3897 12.671 15.199 12.75 15.0001 12.75H4.02707L5.98807 14.43C6.13924 14.5594 6.23281 14.7436 6.24819 14.942C6.26357 15.1404 6.19949 15.3368 6.07007 15.488C5.94064 15.6392 5.75647 15.7327 5.55805 15.7481C5.35964 15.7635 5.16324 15.6994 5.01207 15.57L1.51207 12.57C1.42973 12.4996 1.36363 12.4122 1.31831 12.3138C1.27298 12.2154 1.24951 12.1083 1.24951 12C1.24951 11.8917 1.27298 11.7846 1.31831 11.6862C1.36363 11.5878 1.42973 11.5004 1.51207 11.43L5.01207 8.43C5.08692 8.36591 5.17367 8.3172 5.26735 8.28664C5.36103 8.25607 5.45981 8.24426 5.55805 8.25188C5.6563 8.25949 5.75208 8.28638 5.83993 8.33101C5.92778 8.37565 6.00598 8.43714 6.07007 8.512C6.13415 8.58685 6.18287 8.67359 6.21343 8.76727C6.24399 8.86095 6.2558 8.95973 6.24819 9.05798C6.24057 9.15622 6.21368 9.25201 6.16905 9.33986C6.12442 9.42771 6.06292 9.50591 5.98807 9.57L4.02807 11.25H15.0001Z"
              fill="#FF3838" />
          </svg>

          <span class="ml-3 text-[#FF3838]">Sair do Môdulo</span>
        </div>
      </div>
    </div>
  </header>

  <div class="mt-16 w-full">
    <div class="flex max-w-6xl flex-col my-0 mx-auto px-8 items-start justify-start">

      <form class="flex w-full items-start justify-between mt-11" enctype="multipart/form-data">
        <div class="w-[40%]">

          <label class="text-[#7A7A7A]">Foto anexada do item <strong
              class="text-[#F58220]">#{{item.id}}</strong></label>
          <div class="relative mt-2">
            <div id="foto_preview" class="mb-2 w-full">
              <img src="{{ url_for('static', filename='assets/img/' + item.foto_anexada) }}" alt="Foto do Item"
                class="w-full h-[30%] object-cover rounded-md">
            </div>
          </div>
        </div>

        <div class="w-[55%]">
          <div>
            <span for="tipo_item" class="text-[#444444]">Tipo de Item: </span>

            <!-- # Tipos de itens
            # 1 - Troca
            # 2 - Venda
            # 3 - Doação -->

            {% if item.tipo == 1 %}
            <span class="ml-2 text-[#417453]"><strong>Troca</strong></span>
            {% elif item.tipo == 2 %}
            <span class="ml-2 text-[#F58220]"><strong>Venda</strong></span>
            {% elif item.tipo == 3 %}
            <span class="ml-2 text-[#EE43B4]"><strong>Doação</strong></span>
            {% endif %}
          </div>

          <div class="mt-3">
            <p for="tipo_item" class="text-[#444444]">Categoria: <span class="text-[#7A7A7A]">{{item.categoria}}</span>
            </p>
          </div>


          <div class="mt-3">
            <p class="text-[#444444]">Quantidade: <span class="text-[#7A7A7A]">{{item.quantidade}}</span></p>
          </div>

          <div class="mt-3">
            <label class="block leading-6 text-[#444444]">Nome do Item:</label>
            <div>
              <span class="text-[#7A7A7A]">{{item.nome_item}}</span>
            </div>
          </div>

          <div class="mt-3">
            <label for="descricao_item" class="block leading-6 text-[#444444]">Descrição do Item:</label>
            <div>
              <span class="text-[#7A7A7A]">{{item.descricao}}</span>
            </div>
          </div>

          <div class="mt-3">
            <label for="condicao_item" class="block leading-6 text-[#444444]">Condição do Item:</label>
            <div>
              <span class="text-[#7A7A7A]">{{item.condicao}}</span>
            </div>

            <div class="mt-3">
              <label for="conclusao_item" class="text-[#7A7A7A]">Conclusão de Avaliação</label>
              <div class="flex items-center">
                <input type="radio" id="troca" name="conclusao_item" value="2" class="mr-2">
                <label for="troca" class="text-[#444444]">Aprovado</label>
              </div>
              <div class="flex items-center">
                <input type="radio" id="doacao" name="conclusao_item" value="3" class="mr-2">
                <label for="doacao" class="text-[#444444]">Reprovado</label>
              </div>
            </div>

            <div class="mt-3">
              Critérios:<br />
              Faixa de valor | Condição<br />
              0R$-50R$ = 2 pontos | Ruim = Não aprovado<br />
              50R$-100R$ = 4 pontos | Mediano = 5<br />
              100R$-500R$ = 6 pontos | Bom = 10 pontos<br />
              500R$-1000+ = 8 pontos | Excelente = 15 pontos</p>

              <div class="mt-3 flex items-center">
                <p class="text-[#444444]">Digite a pontuação de créditos:<br />
                  
                <div class="ml-4 flex items-center rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-[#F58220] w-32">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_19_806)">
                      <path
                        d="M12 24C18.6274 24 24 18.6274 24 12C24 5.37258 18.6274 0 12 0C5.37258 0 0 5.37258 0 12C0 18.6274 5.37258 24 12 24Z"
                        fill="#417453" />
                      <path
                        d="M6.89151 17.1084C6.75401 16.9708 6.68525 16.7958 6.68525 16.5833C6.68525 16.3708 6.75401 16.1958 6.89151 16.0582L7.92276 15.027C7.52276 14.5145 7.21325 13.9458 6.99425 13.3208C6.77525 12.6958 6.66601 12.0333 6.66651 11.3333C6.66651 9.65831 7.24776 8.23957 8.41025 7.07706C9.57276 5.91457 10.9915 5.33331 12.6665 5.33331H18.6665V11.3333C18.6665 13.0083 18.0853 14.427 16.9228 15.5896C15.7602 16.7521 14.3416 17.3333 12.6665 17.3333C11.9665 17.3333 11.307 17.2238 10.688 17.0048C10.069 16.7858 9.50351 16.4765 8.99151 16.077L7.94151 17.1084C7.80401 17.2458 7.62901 17.3145 7.41651 17.3145C7.20401 17.3145 7.02901 17.2458 6.89151 17.1084ZM9.92901 14.0708C10.0665 14.2333 10.2415 14.3116 10.454 14.3056C10.6665 14.2996 10.8478 14.2213 10.9978 14.0708L13.9416 11.1271C14.0916 10.9771 14.1665 10.7991 14.1665 10.5931C14.1665 10.3871 14.0916 10.2088 13.9416 10.0583C13.804 9.92082 13.629 9.85206 13.4165 9.85206C13.204 9.85206 13.029 9.92082 12.8915 10.0583L9.92901 13.0208C9.79151 13.1583 9.72276 13.3303 9.72276 13.5368C9.72276 13.7433 9.79151 13.9213 9.92901 14.0708Z"
                        fill="white" />
                    </g>
                    <defs>
                      <clipPath id="clip0_19_806">
                        <rect width="24" height="24" fill="white" />
                      </clipPath>
                    </defs>
                  </svg>

                  <input class="outline-none border-0 ml-2 w-full" name="creditos_atribuir" type="number" placeholder="Ex: 1">
                </div>
              </div>
            </div>

            <div class="mt-4">
              <p class="text-[#7A7A7A]" style="line-height: 1rem;"><strong class="text-red-500">OBS.:</strong> Caso o
                item seja <strong class="text-[#417453]">aprovado</strong> será atribuido automaticamente ao remetente
                dele o crédito informado.</p>
            </div>

            <div class="mt-3 mb-9">
              <button type="submit" id="send-avaliacao-button"
                class="flex w-full justify-center rounded-md bg-[#F58220] px-3 py-1.5 leading-6 text-white shadow-sm hover:bg-[#D8711A] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2">Confirmar
                Avaliação</button>
            </div>

            <!-- <div
            class="flex mt-4  w-full cursor-pointer items-center justify-center py-2 px-4 rounded-md bg-[#F58220] hover:bg-[#D8711A]">
            <span class="ml-3 text-white">Enviar para Avaliação</span>
          </div> -->
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
<script defer>
  const form = document.querySelector('form');
  let itemID = "{{ item.id }}";
  let remetenteID = "{{ item.remetente_id }}";

  let tokenUser = {};
  let userInfo = {};
  let count = 0;

  init();

  function init() {
    count++;

    const userToken = JSON.parse(localStorage.getItem('userToken'));
    const todosAcessos = document.querySelectorAll('[todos_acessos]');

    if (userToken?.token && count === 2) {
      getUserLogged(userToken.token);
    } else {
      console.log('Não há usuário logado', count);
      // window.location.replace('/menu');
    }

    // Função para pegar o usuário logado
    async function getUserLogged(token) {
      try {
        const response = await fetch(`/api/userInfo?token=${token}`);
        const data = await response.json();

        if (data.status === 200) {
          userInfo = data.user;

          console.log("=> user", data);

          if (data.user.nivel_acesso !== "funcionario") {
            window.location.replace('/menu');
            alert('Erro: Você não tem acesso a essa página');
            return
          }

          setUserInfo();
        } else {
          console.log('Não há usuário logado');
          // window.location.replace('/menu');
        }

        return data;
      } catch (error) {
        alert('Erro ao buscar usuário logado');
      }
    }

    // Função para setar as informações do usuário logado
    function setUserInfo() {
      const nomeUsuario = document.querySelector('[nome_usuario]');
      const creditosUsuario = document.querySelector('[creditos_usuario]');

      nomeUsuario.innerHTML = userInfo.nome;
      creditosUsuario.innerHTML = `${userInfo.creditos} Ecoins`;

    }
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const data = new FormData(form);
    const value = Object.fromEntries(data.entries());

    if (!value.conclusao_item) {
      alert('Por favor, selecione uma opção de conclusão de avaliação');
      return;
    }

    if (value.conclusao_item === '2' && !value.creditos_atribuir) {
      alert('Por favor, digite a quantidade de créditos a ser atribuido ao usuário');
      return;
    }

    console.log("value.conclusao_item", value.conclusao_item);
    console.log("value.creditos_atribuir", !value.creditos_atribuir);
    console.log(value.conclusao_item === 2 && !value.creditos_atribuir);

    const valueData = {
      ...value,
      id_item: itemID,
      id_usuario: remetenteID
    }
    sendAvaliation(valueData);
  });

  // Função para sair do módulo
  function backModule() {
    window.location.replace('/menu');
  }

  // Função para voltar
  function back() {
    window.location.replace('/avaliacao_itens');
  }

  // Função para enviar os dados do formulário para a avaliação
  async function sendAvaliation(data) {
    try {
      console.warn(data);
      const response = await fetch(`/api/avaliarItem`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const responseData = await response.json();

      if (responseData.status === 200) {
        alert('Sucesso:Avaliação enviada com sucesso');
        window.location.replace('/avaliacao_itens');
      } else {
        alert('Erro:Erro ao enviar a confirmação de avaliação');
      }

    } catch (error) {
      console.error(error);
      alert('Erro ao enviar a confirmação de avaliação');
    }
  }

</script>
{% endblock %}...